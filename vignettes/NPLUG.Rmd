---
title: "NPLUG"
output: 
  html_document:
    theme: simplex
    toc: true
    toc_depth: 2
    toc_float: true
vignette: >
  %\VignetteIndexEntry{NPLUG}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The NPLUG (**N**itrogen, **P**hosphorous, **L**eucine, **U**racil, or **G**lucose) experiment of [Boer et al. 2010](https://pubmed.ncbi.nlm.nih.gov/19889834/) explored the impacts of nutrient limitation and growth rate on the yeast' metabolome.

Growth conditions in chemostat culture (indefinite exponential growth) followed a full factorial experimental design, such that the 25 primary experimental conditions contained all pairs of:

- 5 limiting nutrients: nitrogen, phosphorous, and glucose, as well as leucine and uracil in auxotrophs.
- 5 dilution rates (growth rate / ln(2)): from 0.05-0.3 hrs^-1^.

In total, 136 biological samples were collected. Two extraction methods were used on each culture (pellet- or filter-based) and each extraction method had two technical replicates. In addition, each batch of experimental cultures was paired with a phosphate-limited slow growth (DR = 0.05 hrs^-1^) reference culture to correct for week-to-week variability.

This study demonstrates the nature of nutrient limitation massively impacts the metabolome, with some growth-limiting metabolites becoming greatly depleted and other metabolites appearing to overflow. This vignette reproduces some of the major findings of this study using the standard functionality built into **claman**.

***

# Data Import

claman is meant to nicely interface with .mzrollDB SQLite databases produced by [MAVEN](https://github.com/eugenemel/maven), the Metabolomics Analysis and Visualization ENgine. Accordingly, we can start with a .mzrollDB file containing a stripped-down version of the NPLUG data, which bas been bundled with the claman package.

```{r data_loading, message = FALSE}
library(claman)

library(dplyr)
library(ggplot2)

mzroll_db_path <- nplug_mzroll()
```

This database contains tables of peakgroups (ions with characteristic m/z and rt), samples, and peaks (measurements of peakgroups in each sample). It does not include meta-data about metabolites (such as metabolites' pathways), nor samples (such as the experimental design), so this information will be added later.

## Read .mzrollDB

```{r read_mzroll}
mzroll_list <- process_mzroll(mzroll_db_path)
```

```{r read_mzrolls_tables, echo = FALSE}
util_pretty_khead(mzroll_list$features, caption = "Features table")
util_pretty_khead(mzroll_list$samples, caption = "Samples table")
util_pretty_khead(mzroll_list$measurements, caption = "Measurements table")
```

## Add sample meta-data

```{r read_sample_metadata}
mzroll_list_augmented <- merge_samples_tbl(mzroll_list, nplug_samples, "sample_name")
```

```{r read_sample_metadata_tables, echo = FALSE}
util_pretty_khead(mzroll_list_augmented$samples, 5, caption = "updated mzroll samples table")
```

## Add compounds meta-data

```{r read_compounds_metadata}
mzroll_list_augmented <- merge_compounds_tbl(mzroll_list_augmented, nplug_compounds)
```

```{r read_compounds_metadata_tables, echo = FALSE}
util_pretty_khead(mzroll_list_augmented$features, 5, caption = "updated mzroll features table")
```


# Preliminary Analysis

Having loaded the dataset, we can take a quick look at the data using heatmaps.

## Limiting Nutrients and Dilution Rate

The biological variables in the experimental design are limiting nutrient and dilution rate. To look at their influence in shaping the metabolome, we can separate limiting nutrients using facets and order samples based on dilution rate (this will happen naturally if we order alphabetically by sample name).

To make plots like this we can take advantage of the fact that mzroll_lists build on top of the [**romic**](http://www.github.com/calico/romic) *triple_omic* classes.

```{r bio_heatmap}
romic::plot_heatmap(
  mzroll_list_augmented,
  feature_var = "compoundName",
  sample_var = "name",
  value_var = "centered_log2_abundance",
  change_threshold = 5
  ) + facet_grid(~ exp_ref + limitation, scales = "free_x", space = "free_x") +
  ggtitle("Metabolites separated by limiting nutrients")
```

From this plot, its clear that limiting nutrients have a strong role in shaping the metabolome, while dilution rate creates relatively smooth transitions as each limitation progresses from slow growth (left) to fast growth (right).

## Extraction Method and Batch

The technical variables in the experimental design are extraction method, month (which is likely associated with batch effects), and replication. Like the heatmap of limitation above, we can look at how extraction method and month shape the metabolome with heatmaps. 

Since limiting nutrient has a major effect, we'll want to account for it when looking extraction method's impact on metabolome variability.

```{r extraction_heatmap}
romic::plot_heatmap(
  mzroll_list_augmented,
  feature_var = "compoundName",
  sample_var = "name",
  value_var = "centered_log2_abundance",
  change_threshold = 5
  ) + facet_grid(~ limitation + extraction, scales = "free_x", space = "free_x") +
  ggtitle("Metabolites separated by extraction") +
  theme(strip.text = element_text(size = 10))
```

From this plot, there are clear, but often relatively minor effects of exctraction method on metabolite abundances.

To look at month-effects, we can take advantage of the fact that in each month two biological replicate reference cultures were generated. These two cultures can be distinguished in the sample meta-data most easily by subtle differences in their dilution rate.

```{r month_heatmap}
mzroll_list_augmented %>%
  # only look at reference samples
  romic::filter_tomic(
    filter_type = "category",
    filter_table = "samples",
    filter_variable = "exp_ref",
    filter_value = "ref"
    ) %>%
  romic::plot_heatmap(
  feature_var = "compoundName",
  sample_var = "name",
  value_var = "centered_log2_abundance",
  change_threshold = 5
  ) + facet_grid(~ month + DR, scales = "free_x", space = "free_x") +
  ggtitle("References separated by month and distinct cultures (by DR)") +
  theme(strip.text = element_text(size = 10))
```
From this plot, the biological replicate reference cultures are nearly identical (that's one reason why chemostats are awesome!) while there are subtle differences between months.

# Normalization

From the preliminary analysis, when normalizing this dataset to remove sources of technical variability (and thereby clarify the biological signal), we'll want to account of month-to-month variability, extraction methodology, and technical replication.

To tackle these obstacles we will:

1. compare and then collapse techical replicates.
2. contrast experimental conditions with reference conditions to account for month-to-month variability.
3. determine whether one extaction method is superior or whether both can be used for downstream analysis with appropriate normalization.

## Collapsing Technical Replicates

```{r technical_replicates}
plot_compare_injection(
  mzroll_list_augmented,
  grouping_vars = "condition",
  peak_quant_var = "centered_log2_abundance"
  ) + ggtitle("Comparison of injection technical replicates")

mzroll_list_distinct_conditions <- collapse_injections(
  mzroll_list_augmented,
  grouping_vars = "condition",
  peak_quant_vars = c("log2_abundance", "centered_log2_abundance"),
  collapse_fxn = "mean"
  )
```

```{r technical_replicates_table, echo = FALSE}
util_pretty_khead(
  mzroll_list_distinct_conditions$samples,
  caption = "samples aggregated over injections"
)
```

## Contrasting to a Reference Condition

To remove 

```{r}
normalize_peaks(
  mzroll_list_distinct_conditions,
  normalization_method = "reference condition",
  quant_peak_varname = "log2_abundance",
  norm_peak_varname = "normalized_log2_abundance",
  condition_varname = "condition",
  reference_varname = "reference"
)

normalize_peaks(
  mzroll_list_distinct_conditions,
  normalization_method = "reference sample"
)

```

## Accounting for Extraction Method



